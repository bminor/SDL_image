From 12f57b64abecdb610aee44b70d2379c301ce5b09 Mon Sep 17 00:00:00 2001
From: Even Rouault <even.rouault@spatialys.com>
Date: Wed, 15 Aug 2018 16:34:40 +0200
Subject: [PATCH 04/10] TIFFSetupStrips(): avoid potential uint32 overflow on
 32-bit systems with large number of strips. Probably relates to
 http://bugzilla.maptools.org/show_bug.cgi?id=2788 / CVE-2018-10779

---
 libtiff/tif_write.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/libtiff/tif_write.c b/libtiff/tif_write.c
index ce671af..c7c29a5 100644
--- a/libtiff/tif_write.c
+++ b/libtiff/tif_write.c
@@ -484,9 +484,11 @@ TIFFSetupStrips(TIFF* tif)
 	if (td->td_planarconfig == PLANARCONFIG_SEPARATE)
 		td->td_stripsperimage /= td->td_samplesperpixel;
 	td->td_stripoffset = (uint64 *)
-	    _TIFFmalloc(td->td_nstrips * sizeof (uint64));
+            _TIFFCheckMalloc(tif, td->td_nstrips, sizeof (uint64),
+                             "for \"StripOffsets\" array");
 	td->td_stripbytecount = (uint64 *)
-	    _TIFFmalloc(td->td_nstrips * sizeof (uint64));
+            _TIFFCheckMalloc(tif, td->td_nstrips, sizeof (uint64),
+                             "for \"StripByteCounts\" array");
 	if (td->td_stripoffset == NULL || td->td_stripbytecount == NULL)
 		return (0);
 	/*
-- 
2.17.2

